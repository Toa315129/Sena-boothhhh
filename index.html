<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SENA PHOTOBOOTH: PAPER EDITION</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mali:wght@300;500;700&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root {
            /* ‡∏î‡∏∂‡∏á‡∏™‡∏µ‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏π‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏£‡∏π‡∏õ */
            --paper: #F3E9D2;      /* ‡∏™‡∏µ‡∏Ñ‡∏£‡∏µ‡∏°‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏•‡∏±‡∏á */
            --ink: #2C3E50;        /* ‡∏™‡∏µ‡∏´‡∏°‡∏∂‡∏Å‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤ */
            --accent: #2980B9;     /* ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏π‡πâ */
            --highlight: #E74C3C;  /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏ô‡∏¥‡∏î‡πÜ */
            --radius: 20px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--paper);
            color: var(--ink);
            font-family: 'Mali', cursive; /* ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠ */
            overflow: hidden;
            background-image: radial-gradient(#dcd0b8 2px, transparent 2px);
            background-size: 30px 30px; /* ‡∏•‡∏≤‡∏¢‡∏à‡∏∏‡∏î‡∏à‡∏≤‡∏á‡πÜ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏™‡∏°‡∏∏‡∏î */
        }

        /* --- UI COMPONENTS --- */
        .screen {
            position: fixed; inset: 0; 
            display: none; flex-direction: column; 
            align-items: center; justify-content: center;
            transition: opacity 0.4s;
        }
        .screen.active { display: flex; z-index: 10; }

        .btn {
            background: var(--ink); color: white;
            border: 3px solid var(--ink);
            padding: 15px 40px;
            font-family: 'Mali', cursive; font-size: 20px; font-weight: 700;
            border-radius: 50px;
            cursor: pointer; box-shadow: 5px 5px 0px rgba(0,0,0,0.1);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px rgba(0,0,0,0.1); }
        .btn-outline { background: transparent; color: var(--ink); }

        /* --- 1. INTRO --- */
        .doodle-box {
            border: 4px solid var(--ink);
            padding: 40px; border-radius: var(--radius);
            background: white;
            box-shadow: 10px 10px 0px var(--accent);
            text-align: center; max-width: 90%;
            transform: rotate(-2deg); /* ‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏ô‡∏¥‡∏î‡πÜ ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏Ç‡∏µ‡πâ‡πÄ‡∏•‡πà‡∏ô */
        }
        h1 { font-size: 60px; margin: 0; color: var(--accent); text-transform: uppercase; letter-spacing: 5px; }
        p { font-size: 24px; margin-top: 10px; opacity: 0.7; }

        /* --- 2. CAMERA --- */
        .cam-wrapper {
            position: relative;
            width: 100%; max-width: 600px;
            padding: 20px;
        }
        .viewfinder {
            width: 100%; aspect-ratio: 3/4;
            background: #000;
            border: 8px solid white;
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            overflow: hidden; position: relative;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        .controls {
            margin-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px;
        }
        .filters {
            display: flex; gap: 10px; overflow-x: auto; padding: 10px; width: 100%; justify-content: center;
        }
        .f-dot {
            width: 50px; height: 50px; border-radius: 50%; border: 3px solid var(--paper);
            cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.2s;
            display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; background: white;
        }
        .f-dot.active { transform: scale(1.2); border-color: var(--ink); }

        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 150px; color: white; font-weight: bold; 
            text-shadow: 4px 4px 0 var(--ink); display: none;
        }

        /* --- 3. FRAME SELECT --- */
        .frame-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;
            margin: 30px 0;
        }
        .frame-opt {
            width: 120px; height: 160px; background: white;
            border: 4px solid #ddd; border-radius: 10px; cursor: pointer;
            position: relative; transition: 0.2s;
        }
        .frame-opt.selected { border-color: var(--accent); transform: translateY(-10px); box-shadow: 0 10px 20px rgba(41, 128, 185, 0.2); }
        .frame-opt::after { content:''; position: absolute; inset: 15px; background: #eee; }

        /* --- 4. RESULT --- */
        .result-card {
            background: white; padding: 20px; border-radius: var(--radius);
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 350px; width: 100%;
        }
        #final-preview { width: 100%; border-radius: 5px; border: 2px solid #eee; margin-bottom: 20px; }
        
        #qr-area {
            min-height: 150px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #f9f9f9; border-radius: 10px; padding: 15px; margin-bottom: 15px;
        }
        .status-text { font-size: 14px; margin-top: 10px; color: #888; }

        /* Animation Utils */
        .flash { position: fixed; inset: 0; background: white; z-index: 99; opacity: 0; pointer-events: none; transition: opacity 0.1s; }
    </style>
</head>
<body>

    <div class="flash" id="flash-effect"></div>

    <div id="screen-intro" class="screen active">
        <div class="doodle-box animate__animated animate__bounceIn">
            <h1>SENA</h1>
            <div style="font-size:30px; letter-spacing:2px; font-weight:700;">PHOTOBOOTH</div>
            <div style="margin:20px 0; font-size:40px;">üì∏ ‚ú® üñºÔ∏è</div>
            <p>‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</p>
            <button class="btn" onclick="app.start()">START</button>
        </div>
        <div style="position:absolute; bottom:20px; font-size:12px; opacity:0.5;">@SAPHASENA68</div>
    </div>

    <div id="screen-camera" class="screen">
        <div class="cam-wrapper">
            <div class="viewfinder">
                <video id="video" autoplay playsinline muted></video>
                <div id="countdown">3</div>
            </div>
            
            <div class="controls">
                <div style="font-weight:bold;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ó‡∏ô‡∏™‡∏µ (Filter)</div>
                <div class="filters">
                    <div class="f-dot active" onclick="app.setFilter('none', this)" style="background:#ddd;">Normal</div>
                    <div class="f-dot" onclick="app.setFilter('grayscale(100%) contrast(1.2)', this)" style="background:#555; color:white;">B&W</div>
                    <div class="f-dot" onclick="app.setFilter('sepia(0.5) contrast(1.1) brightness(1.1)', this)" style="background:#d4b08c;">Warm</div>
                    <div class="f-dot" onclick="app.setFilter('brightness(1.1) saturate(1.2) contrast(1.1)', this)" style="background:#ffb7b2;">Pop</div>
                </div>
                <button class="btn" style="width:80px; height:80px; border-radius:50%; margin-top:10px; font-size:30px;" onclick="app.snap()">üì∑</button>
            </div>
        </div>
    </div>

    <div id="screen-frame" class="screen">
        <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡∏£‡∏π‡∏õ</h2>
        <div class="frame-grid">
            <div class="frame-opt selected" onclick="app.setFrame('#ffffff', this)" style="background:#ffffff;"></div>
            <div class="frame-opt" onclick="app.setFrame('#2980B9', this)" style="background:#2980B9;"></div> <div class="frame-opt" onclick="app.setFrame('#F3E9D2', this)" style="background:#F3E9D2;"></div> <div class="frame-opt" onclick="app.setFrame('#2C3E50', this)" style="background:#2C3E50;"></div>
        </div>
        <button class="btn" onclick="app.process()">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
    </div>

    <div id="screen-result" class="screen">
        <div class="result-card animate__animated animate__fadeInUp">
            <img id="final-preview" src="">
            
            <div id="qr-area">
                <div id="qr-code"></div>
                <div id="qr-status" class="status-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>

            <button id="dl-btn" class="btn" style="display:none; width:100%; background:#27ae60; border-color:#27ae60;" onclick="app.download()">
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            </button>
            
            <div style="margin-top:15px; cursor:pointer; text-decoration:underline;" onclick="location.reload()">‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</div>
        </div>
    </div>

    <audio id="snd-click" src="https://www.soundjay.com/communication/shutter-click-06.mp3"></audio>

    <script>
        const app = {
            photos: [],
            filter: 'none',
            frameColor: '#ffffff',
            isShooting: false,
            
            start: async function() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { width: 1280, height: 720, facingMode: "user" } 
                    });
                    document.getElementById('video').srcObject = stream;
                    this.nav('camera');
                } catch(e) { alert("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡πâ‡∏≤: " + e); }
            },

            nav: (id) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('screen-' + id).classList.add('active');
            },

            setFilter: function(val, el) {
                this.filter = val;
                document.getElementById('video').style.filter = val;
                document.querySelectorAll('.f-dot').forEach(d => d.classList.remove('active'));
                el.classList.add('active');
            },

            setFrame: function(color, el) {
                this.frameColor = color;
                document.querySelectorAll('.frame-opt').forEach(d => d.classList.remove('selected'));
                el.classList.add('selected');
            },

            snap: async function() {
                if(this.isShooting) return;
                this.isShooting = true;
                this.photos = [];

                for(let i=1; i<=3; i++) { // ‡∏ñ‡πà‡∏≤‡∏¢ 3 ‡∏ä‡πá‡∏≠‡∏ï
                    await this.countdown(3);
                    this.capture();
                    await new Promise(r => setTimeout(r, 1000));
                }
                this.isShooting = false;
                this.nav('frame');
            },

            countdown: function(sec) {
                return new Promise(resolve => {
                    const el = document.getElementById('countdown');
                    el.style.display = 'block';
                    el.innerText = sec;
                    let c = sec;
                    const t = setInterval(() => {
                        c--;
                        if(c > 0) el.innerText = c;
                        else {
                            clearInterval(t);
                            el.style.display = 'none';
                            resolve();
                        }
                    }, 1000);
                });
            },

            capture: function() {
                const vid = document.getElementById('video');
                const cvs = document.createElement('canvas');
                cvs.width = vid.videoWidth; cvs.height = vid.videoHeight;
                const ctx = cvs.getContext('2d');
                
                // Flash Effect
                const flash = document.getElementById('flash-effect');
                flash.style.opacity = 1;
                document.getElementById('snd-click').play();
                setTimeout(() => flash.style.opacity = 0, 150);

                // Flip & Draw
                ctx.translate(cvs.width, 0); ctx.scale(-1, 1);
                
                // --- ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ù‡∏±‡∏á‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÄ‡∏•‡∏¢ ---
                if(this.filter !== 'none') ctx.filter = this.filter;
                ctx.drawImage(vid, 0, 0);
                
                this.photos.push(cvs.toDataURL('image/jpeg', 0.9));
            },

            process: async function() {
                const cvs = document.createElement('canvas');
                cvs.width = 600; cvs.height = 1800; // Strip ‡∏¢‡∏≤‡∏ß
                const ctx = cvs.getContext('2d');

                // 1. ‡πÄ‡∏ó‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (Frame Color)
                ctx.fillStyle = this.frameColor;
                ctx.fillRect(0, 0, cvs.width, cvs.height);

                // 2. ‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ
                const padding = 40;
                const imgW = 600 - (padding*2);
                const imgH = imgW * 0.75; // 4:3 ratio
                let y = padding + 50; // ‡πÄ‡∏ß‡πâ‡∏ô‡∏´‡∏±‡∏ß‡∏ö‡∏ô‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢

                for(let src of this.photos) {
                    const img = await new Promise(r => { const i=new Image(); i.onload=()=>r(i); i.src=src; });
                    
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≠‡∏ö‡∏Ç‡∏≤‡∏ß‡∏£‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Polaroid
                    ctx.fillStyle = "white";
                    ctx.fillRect(padding - 10, y - 10, imgW + 20, imgH + 20);
                    
                    ctx.drawImage(img, padding, y, imgW, imgH);
                    y += imgH + 60;
                }

                // 3. ‡πÉ‡∏™‡πà‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
                ctx.fillStyle = (this.frameColor === '#2C3E50' || this.frameColor === '#2980B9') ? 'white' : '#2C3E50';
                ctx.font = "bold 50px 'Courier New'";
                ctx.textAlign = "center";
                ctx.fillText("SENA PHOTO", 300, 1720);
                
                // Final Blob
                const finalData = cvs.toDataURL('image/jpeg', 0.95);
                document.getElementById('final-preview').src = finalData;
                
                this.nav('result');
                this.upload(finalData);
            },

            upload: async function(base64) {
                const status = document.getElementById('qr-status');
                const dlBtn = document.getElementById('dl-btn');
                const qrBox = document.getElementById('qr-code');
                
                qrBox.innerHTML = '';
                status.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code...";
                dlBtn.style.display = 'none';

                try {
                    // ‡πÉ‡∏ä‡πâ Free Key ‡∏Ç‡∏≠‡∏á ImgBB (‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏µ‡∏¢‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏ï‡πá‡∏° ‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà api.imgbb.com ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏á key=...)
                    const apiKey = '676d911b6678b8723c3b0f55e3780a47'; 
                    const formData = new FormData();
                    formData.append('image', base64.split(',')[1]);

                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, { method:'POST', body:formData });
                    const data = await res.json();

                    if(data.success) {
                        new QRCode(qrBox, {
                            text: data.data.url,
                            width: 150, height: 150,
                            colorDark: "#2C3E50",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.L
                        });
                        status.innerText = "‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏à‡πâ‡∏≤";
                    } else {
                        throw new Error('Upload Failed');
                    }
                } catch(e) {
                    // Fallback ‡πÄ‡∏°‡∏∑‡πà‡∏≠ QR ‡∏û‡∏±‡∏á
                    console.error(e);
                    qrBox.innerHTML = '<span style="font-size:30px;">‚ö†Ô∏è</span>';
                    status.innerHTML = "‡πÄ‡∏ô‡πá‡∏ï‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ã‡∏¥‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏ï‡πá‡∏°<br>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏ü‡∏£‡∏π‡∏õ‡πÅ‡∏ó‡∏ô‡∏ô‡∏∞";
                    dlBtn.style.display = 'block'; // ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ó‡∏ô
                }
            },

            download: function() {
                const link = document.createElement('a');
                link.download = 'sena-photo.jpg';
                link.href = document.getElementById('final-preview').src;
                link.click();
            }
        };
    </script>
</body>
</html>
