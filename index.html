<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SENA PRESTIGE BOOTH ✦</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;400;600&family=Prompt:wght@100;300;500&display=swap" rel="stylesheet">

    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --color-bg: #FFFFFF;
            --color-text: #1A1A1A;
            --color-sub: #8E8E93;
            --color-accent: #D4AF37; /* Gold slight hint for luxury */
            --color-k-blue: #EBF4FF; /* Korean Blue Tint */
            --font-main: 'Montserrat', 'Prompt', sans-serif;
            --safe-area: 40px;
        }

        * {
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            touch-action: manipulation;
        }

        body, html {
            margin: 0; padding: 0; width: 100vw; height: 100vh;
            background: var(--color-bg); color: var(--color-text);
            font-family: var(--font-main); overflow: hidden;
        }

        /* --- BACKGROUND DECOR --- */
        .sketch-bg {
            position: fixed; inset: 0; z-index: -1; opacity: 0.4;
            pointer-events: none;
        }
        .sparkle {
            position: absolute; color: var(--color-text);
            font-size: 20px; animation: blink 3s infinite;
        }
        @keyframes blink { 0%, 100% { opacity: 0.2; } 50% { opacity: 0.8; } }

        /* --- APP WRAPPER --- */
        #app-container {
            width: 100%; height: 100%; position: relative;
        }

        .view-layer {
            position: absolute; inset: 0;
            display: none; flex-direction: column;
            align-items: center; justify-content: center;
            padding: var(--safe-area);
        }
        .view-layer.active { display: flex; }

        /* --- 1. HOME SCREEN --- */
        .home-logo {
            font-weight: 200; font-size: 80px; letter-spacing: 20px;
            margin-bottom: 10px; text-transform: uppercase;
        }
        .home-sub {
            font-weight: 300; font-size: 14px; letter-spacing: 5px;
            color: var(--color-sub); margin-bottom: 60px;
        }
        .start-trigger {
            width: 200px; height: 200px; border-radius: 50%;
            border: 1px solid #E0E0E0; display: flex;
            align-items: center; justify-content: center;
            cursor: pointer; transition: 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            position: relative;
        }
        .start-trigger:hover { transform: scale(1.05); border-color: var(--color-text); }
        .start-trigger::before {
            content: ''; position: absolute; inset: -10px;
            border-radius: 50%; border: 1px solid #F0F0F0;
        }

        /* --- 2. CAMERA VIEW --- */
        .camera-ui-grid {
            display: grid; grid-template-columns: 1fr 400px; gap: 40px;
            width: 100%; height: 85vh; max-width: 1400px;
        }
        
        .viewport-wrapper {
            position: relative; width: 100%; height: 100%;
            background: #F9F9F9; border-radius: 4px; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        #webcam {
            width: 100%; height: 100%; object-fit: cover;
            transform: scaleX(-1); /* Mirror */
        }
        
        .camera-controls {
            display: flex; flex-direction: column; justify-content: center;
            align-items: flex-start; gap: 30px; padding-left: 20px;
        }
        .mode-title { font-size: 24px; font-weight: 600; letter-spacing: 2px; }

        .filter-shelf {
            display: flex; flex-direction: column; gap: 12px; width: 100%;
        }
        .filter-option {
            padding: 15px 20px; border: 1px solid #EEE; border-radius: 2px;
            cursor: pointer; font-size: 13px; letter-spacing: 1px;
            transition: 0.3s; display: flex; justify-content: space-between;
        }
        .filter-option.active { background: var(--color-text); color: #FFF; border-color: var(--color-text); }

        .shutter-group {
            margin-top: 40px; display: flex; align-items: center; gap: 20px;
        }
        .shutter-btn {
            width: 80px; height: 80px; border-radius: 50%;
            background: var(--color-text); display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: 0.3s;
        }
        .shutter-btn:active { transform: scale(0.9); }
        .shutter-btn svg { width: 30px; fill: #FFF; }

        /* --- 3. EDITOR / PREVIEW --- */
        .editor-grid {
            display: flex; gap: 50px; align-items: center;
        }
        .strip-canvas-area {
            background: #FFF; padding: 15px; box-shadow: 0 30px 60px rgba(0,0,0,0.1);
            transform: rotate(-1deg);
        }
        .color-picker {
            display: grid; grid-template-columns: repeat(2, 60px); gap: 15px;
        }
        .color-circle {
            width: 60px; height: 60px; border-radius: 50%; cursor: pointer;
            border: 1px solid #EEE; position: relative;
        }
        .color-circle.active::after {
            content: '✦'; position: absolute; top: -15px; right: -5px; font-size: 20px;
        }

        /* --- 4. SUCCESS / QR --- */
        .success-wrap {
            text-align: center;
        }
        #qrcode-output {
            background: #FFF; padding: 20px; border: 1px solid #F0F0F0;
            margin: 30px 0; display: inline-block;
        }
        .loader-bar {
            width: 200px; height: 2px; background: #F0F0F0; margin: 20px auto;
            position: relative; overflow: hidden;
        }
        .loader-bar::after {
            content: ''; position: absolute; left: -100%; width: 100%; height: 100%;
            background: var(--color-text); animation: loading 2s infinite;
        }
        @keyframes loading { to { left: 100%; } }

        /* --- UTILS --- */
        #flash-overlay {
            position: fixed; inset: 0; background: white; z-index: 9999;
            pointer-events: none; opacity: 0;
        }
        #count-overlay {
            position: absolute; font-size: 180px; font-weight: 200;
            color: #FFF; pointer-events: none; z-index: 10;
        }
        .hidden-canvas { display: none; }
    </style>
</head>
<body>

    <div id="flash-overlay"></div>
    <div class="sketch-bg">
        <span class="sparkle" style="top:10%; left:10%;">✦</span>
        <span class="sparkle" style="top:20%; right:15%;">✧</span>
        <span class="sparkle" style="bottom:15%; left:20%;">✦</span>
        <span class="sparkle" style="bottom:25%; right:10%;">✧</span>
    </div>

    <div id="app-container">
        
        <section id="screen-home" class="view-layer active">
            <h1 class="home-logo animate__animated animate__fadeIn">SENA</h1>
            <p class="home-sub">MOMENT CAPTURE STUDIO ✦</p>
            <div class="start-trigger" onclick="Booth.nav('camera')">
                <span style="letter-spacing: 5px; font-weight: 400; font-size: 12px;">START</span>
            </div>
        </section>

        <section id="screen-camera" class="view-layer">
            <div class="camera-ui-grid">
                <div class="viewport-wrapper">
                    <video id="webcam" autoplay playsinline></video>
                    <div id="count-overlay"></div>
                </div>
                
                <div class="camera-controls">
                    <div class="mode-title">SELECT VIBE</div>
                    <div class="filter-shelf">
                        <div class="filter-option active" data-filter="none" onclick="Booth.setFilter(this)">
                            <span>NATURAL</span><span>✦</span>
                        </div>
                        <div class="filter-option" data-filter="grayscale(1) contrast(1.1) brightness(1.1)" onclick="Booth.setFilter(this)">
                            <span>MONO SKETCH</span><span>✧</span>
                        </div>
                        <div class="filter-option" data-filter="brightness(1.1) saturate(1.1) sepia(0.1)" onclick="Booth.setFilter(this)">
                            <span>SOFT GLOW</span><span>✦</span>
                        </div>
                        <div class="filter-option" data-filter="contrast(1.2) saturate(1.4)" onclick="Booth.setFilter(this)">
                            <span>VIVID K-POP</span><span>✧</span>
                        </div>
                    </div>

                    <div class="shutter-group">
                        <div class="shutter-btn" onclick="Booth.startSequence()">
                            <svg viewBox="0 0 24 24"><path d="M12 15.5c2.485 0 4.5-2.015 4.5-4.5s-2.015-4.5-4.5-4.5-4.5 2.015-4.5 4.5 2.015 4.5 4.5 4.5z"/><path d="M20 4h-3.17l-1.83-2h-6l-1.83 2h-3.17c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2v-12c0-1.1-.9-2-2-2zm-8 15c-3.866 0-7-3.134-7-7s3.134-7 7-7 7 3.134 7 7-3.134 7-7 7z"/></svg>
                        </div>
                        <div style="font-size: 12px; letter-spacing: 2px;">READY TO SNAP?</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="screen-editor" class="view-layer">
            <div class="editor-grid">
                <div class="strip-canvas-area" id="preview-area">
                    </div>
                
                <div class="editor-controls" style="width: 300px;">
                    <h2 style="font-weight: 300; letter-spacing: 4px; margin-bottom: 30px;">THEME</h2>
                    <div class="color-picker">
                        <div class="color-circle active" style="background: #FFF;" onclick="Booth.setTheme('#FFFFFF', this)"></div>
                        <div class="color-circle" style="background: #1A1A1A;" onclick="Booth.setTheme('#1A1A1A', this)"></div>
                        <div class="color-circle" style="background: #EBF4FF;" onclick="Booth.setTheme('#EBF4FF', this)"></div>
                        <div class="color-circle" style="background: #FDF2F8;" onclick="Booth.setTheme('#FDF2F8', this)"></div>
                    </div>
                    <button class="shutter-btn" style="width: 100%; border-radius: 4px; margin-top: 50px;" onclick="Booth.generateFinal()">
                        <span style="color: #FFF; letter-spacing: 3px; font-size: 12px;">FINALIZE</span>
                    </button>
                </div>
            </div>
        </section>

        <section id="screen-final" class="view-layer">
            <div class="success-wrap">
                <div style="font-size: 40px; margin-bottom: 10px;">✦</div>
                <h2 style="font-weight: 200; letter-spacing: 10px;">SUCCESS</h2>
                <div id="qrcode-output"></div>
                <div id="status-msg" style="font-size: 12px; letter-spacing: 2px; opacity: 0.6;">UPLOADING TO CLOUD...</div>
                <div class="loader-bar"></div>
                
                <div style="margin-top: 40px;">
                    <button class="filter-option" style="display: inline-block; padding: 10px 40px;" onclick="location.reload()">DONE</button>
                </div>
            </div>
        </section>

    </div>

    <audio id="snd-shutter" src="https://assets.mixkit.co/active_storage/sfx/2857/2857-preview.mp3"></audio>

    <script>
        const Booth = {
            // Configuration
            config: {
                photosCount: 4,
                apiEndpoint: 'https://api.imgbb.com/1/upload',
                apiKey: '676d911b6678b8723c3b0f55e3780a47', // Your provided key
                countdown: 3
            },

            // App State
            state: {
                stream: null,
                rawPhotos: [],
                filter: 'none',
                theme: '#FFFFFF',
                isShooting: false
            },

            // Initialization
            init: async function() {
                this.nav('home');
                console.log("SENA System Ready ✦");
            },

            // Navigation System
            nav: async function(screen) {
                const layers = document.querySelectorAll('.view-layer');
                gsap.to(layers, { opacity: 0, duration: 0.4, onComplete: () => {
                    layers.forEach(l => l.classList.remove('active'));
                    const target = document.getElementById('screen-' + screen);
                    target.classList.add('active');
                    gsap.to(target, { opacity: 1, duration: 0.6 });
                    
                    if(screen === 'camera') this.setupCamera();
                }});
            },

            setupCamera: async function() {
                try {
                    this.state.stream = await navigator.mediaDevices.getUserMedia({
                        video: { width: 1920, height: 1080, facingMode: "user" }
                    });
                    document.getElementById('webcam').srcObject = this.state.stream;
                } catch(e) {
                    alert("Unable to access high-def camera.");
                }
            },

            setFilter: function(el) {
                this.state.filter = el.dataset.filter;
                document.getElementById('webcam').style.filter = this.state.filter;
                document.querySelectorAll('.filter-option').forEach(opt => opt.classList.remove('active'));
                el.classList.add('active');
            },

            setTheme: function(color, el) {
                this.state.theme = color;
                document.querySelectorAll('.color-circle').forEach(opt => opt.classList.remove('active'));
                el.classList.add('active');
                this.renderPreview();
            },

            // Main Action: Shooting
            startSequence: async function() {
                if(this.state.isShooting) return;
                this.state.isShooting = true;
                this.state.rawPhotos = [];
                
                const countEl = document.getElementById('count-overlay');
                const snd = document.getElementById('snd-shutter');

                for(let i=0; i < this.config.photosCount; i++) {
                    // Countdown
                    for(let c = this.config.countdown; c > 0; c--) {
                        countEl.innerText = c;
                        gsap.fromTo(countEl, { scale: 0.5, opacity: 0 }, { scale: 1, opacity: 1, duration: 0.5 });
                        await new Promise(r => setTimeout(r, 1000));
                    }
                    countEl.innerText = "";

                    // Flash & Capture
                    gsap.to("#flash-overlay", { opacity: 1, duration: 0.05, yoyo: true, repeat: 1 });
                    snd.currentTime = 0; snd.play();
                    this.captureFrame();
                    
                    await new Promise(r => setTimeout(r, 800)); // Buffer
                }

                this.state.isShooting = false;
                this.nav('editor');
                this.renderPreview();
            },

            captureFrame: function() {
                const video = document.getElementById('webcam');
                const canvas = document.createElement('canvas');
                canvas.width = 1200; // High resolution capture
                canvas.height = 900;
                const ctx = canvas.getContext('2d');

                // Mirror and apply filter permanently to the pixels
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
                ctx.filter = this.state.filter;
                
                // Draw image
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                this.state.rawPhotos.push(canvas.toDataURL('image/jpeg', 0.9));
            },

            // Advanced Rendering
            renderPreview: async function() {
                const canvas = document.createElement('canvas');
                canvas.width = 800; // Display scale
                canvas.height = 2600;
                const ctx = canvas.getContext('2d');

                // Draw Background
                ctx.fillStyle = this.state.theme;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Draw Photos
                let currentY = 60;
                const padding = 50;
                const imgW = 700;
                const imgH = 525;

                for(let imgData of this.state.rawPhotos) {
                    const img = await this.loadImage(imgData);
                    
                    // Shadow effect for photos
                    ctx.shadowColor = 'rgba(0,0,0,0.05)';
                    ctx.shadowBlur = 20;
                    ctx.fillRect(padding, currentY, imgW, imgH);
                    ctx.shadowBlur = 0;

                    ctx.drawImage(img, padding, currentY, imgW, imgH);
                    currentY += imgH + 40;
                }

                // Brand
                const isDark = this.state.theme === '#1A1A1A';
                ctx.fillStyle = isDark ? '#FFF' : '#1A1A1A';
                ctx.font = "200 60px Montserrat";
                ctx.textAlign = "center";
                ctx.letterSpacing = "15px";
                ctx.fillText("SENA", 400, 2450);
                
                ctx.font = "300 12px Montserrat";
                ctx.letterSpacing = "4px";
                ctx.fillText("✦ MOMENT STUDIO ✧", 400, 2500);

                const previewArea = document.getElementById('preview-area');
                previewArea.innerHTML = '';
                const finalImg = new Image();
                finalImg.src = canvas.toDataURL('image/jpeg');
                finalImg.style.width = "280px"; // Visual scale
                previewArea.appendChild(finalImg);
                this.lastGeneratedBlob = canvas;
            },

            loadImage: (src) => new Promise(r => { const i = new Image(); i.onload = () => r(i); i.src = src; }),

            generateFinal: async function() {
                this.nav('final');
                const fullResCanvas = document.createElement('canvas');
                fullResCanvas.width = 1200;
                fullResCanvas.height = 4000;
                const ctx = fullResCanvas.getContext('2d');

                // Same logic as preview but 1.5x resolution for printing/saving
                ctx.fillStyle = this.state.theme;
                ctx.fillRect(0, 0, fullResCanvas.width, fullResCanvas.height);

                let y = 100;
                for(let data of this.state.rawPhotos) {
                    const img = await this.loadImage(data);
                    ctx.drawImage(img, 100, y, 1000, 750);
                    y += 850;
                }

                // Brand
                const isDark = this.state.theme === '#1A1A1A';
                ctx.fillStyle = isDark ? '#FFF' : '#1A1A1A';
                ctx.textAlign = "center";
                ctx.font = "200 100px Montserrat";
                ctx.fillText("SENA", 600, 3750);

                fullResCanvas.toBlob(blob => {
                    this.uploadAndShowQR(blob);
                }, 'image/jpeg', 0.95);
            },

            uploadAndShowQR: async function(blob) {
                const formData = new FormData();
                formData.append('image', blob);

                try {
                    const response = await fetch(`${this.config.apiEndpoint}?key=${this.config.apiKey}`, {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    
                    if(result.success) {
                        this.displayQR(result.data.url);
                    } else {
                        throw new Error();
                    }
                } catch(e) {
                    document.getElementById('status-msg').innerText = "OFFLINE MODE: PLEASE SAVE MANUALLY";
                    document.getElementById('qrcode-output').innerHTML = "⚠️";
                }
            },

            displayQR: function(url) {
                const container = document.getElementById('qrcode-output');
                container.innerHTML = '';
                new QRCode(container, {
                    text: url,
                    width: 160,
                    height: 160,
                    colorDark : "#1A1A1A",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
                document.getElementById('status-msg').innerText = "SCAN TO GET YOUR PHOTO ✦";
                gsap.to(".loader-bar", { opacity: 0 });
            }
        };

        // Boot
        window.onload = () => Booth.init();
    </script>
</body>
</html>
