<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SENA PHOTOBOOTH - SCAN & SAVE</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --cream-bg: #FFFDF7;
            --soft-blue: #E8F2FF;
            --accent-blue: #B5D5FF;
            --white: #FFFFFF;
            --text-main: #5A6B7F;
            --shadow: 0 10px 30px rgba(181, 213, 255, 0.2);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; font-family: sans-serif; }
        body, html { margin: 0; padding: 0; width: 100vw; height: 100vh; background-color: var(--cream-bg); color: var(--text-main); overflow: hidden; }

        /* --- START --- */
        #startScreen { position: fixed; inset: 0; z-index: 1000; background: radial-gradient(circle, var(--white), var(--soft-blue)); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #startScreen.hide { opacity: 0; visibility: hidden; transition: 0.5s; }
        .start-btn { width: 140px; height: 140px; background: var(--white); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; box-shadow: var(--shadow); border: 6px solid var(--soft-blue); cursor: pointer; }

        /* --- BOOTH --- */
        #boothScreen { display: none; height: 100vh; flex-direction: column; align-items: center; padding: 20px; gap: 15px; }
        .camera-box { position: relative; width: 70%; max-width: 400px; aspect-ratio: 3/4; background: #000; border-radius: 25px; border: 8px solid var(--white); box-shadow: var(--shadow); overflow: hidden; }
        #video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        .inner-previews { position: absolute; right: 10px; top: 10px; bottom: 10px; width: 50px; display: flex; flex-direction: column; gap: 5px; z-index: 5; }
        .mini-slot { width: 100%; aspect-ratio: 1/1; background: rgba(255,255,255,0.2); border-radius: 6px; border: 1.5px solid var(--white); overflow: hidden; opacity: 0; }
        .mini-slot.active { opacity: 1; transition: 0.4s; }
        .mini-slot img { width: 100%; height: 100%; object-fit: cover; }
        #countdown { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 100px; color: white; opacity: 0; pointer-events: none; }

        .btn-main { width: 75px; height: 75px; background: white; border-radius: 50%; border: 6px solid var(--soft-blue); box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; }
        .btn-main-inner { width: 50px; height: 50px; background: var(--accent-blue); border-radius: 50%; }

        /* --- RESULT --- */
        #resultScreen { position: fixed; inset: 0; z-index: 2000; background: var(--cream-bg); display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .result-wrap { display: flex; gap: 20px; align-items: flex-end; }
        .film-strip { background: white; padding: 10px 10px 30px 10px; box-shadow: var(--shadow); width: 220px; display: flex; flex-direction: column; gap: 6px; }
        .film-img { width: 100%; aspect-ratio: 3/2.2; background: #eee; overflow: hidden; }
        .film-img img { width: 100%; height: 100%; object-fit: cover; }

        #qrcode { background: white; padding: 10px; border-radius: 12px; box-shadow: var(--shadow); min-width: 120px; min-height: 120px; display: flex; align-items: center; justify-content: center; }
        .loading-text { font-size: 10px; color: #888; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        #flash { position: absolute; inset: 0; background: white; opacity: 0; z-index: 100; pointer-events: none; }
    </style>
</head>
<body>

    <div id="startScreen">
        <h1 style="font-weight: 200; letter-spacing: 8px;">SENA</h1>
        <div class="start-btn" onclick="openBooth()">START</div>
    </div>

    <div id="boothScreen">
        <div class="camera-box">
            <video id="video" autoplay playsinline></video>
            <div id="countdown">3</div>
            <div id="flash"></div>
            <div class="inner-previews"><div class="mini-slot" id="m0"></div><div class="mini-slot" id="m1"></div><div class="mini-slot" id="m2"></div><div class="mini-slot" id="m3"></div></div>
        </div>
        <div class="btn-main" onclick="startCapture()"><div class="btn-main-inner"></div></div>
    </div>

    <div id="resultScreen">
        <div class="result-wrap">
            <div class="film-strip" id="captureFilm">
                <div id="resultImages"></div>
                <div style="text-align:center; font-size:10px; margin-top:10px; opacity:0.5;">SENA STUDIO</div>
            </div>
            <div style="display:flex; flex-direction:column; align-items:center; gap:10px;">
                <div id="qrcode"><span class="loading-text">สร้าง QR Code...</span></div>
                <div style="font-size: 10px; width: 120px; text-align: center;">สแกนแล้ว "กดค้างที่รูป" เพื่อบันทึกเข้ามือถือ</div>
                <button onclick="location.reload()" style="border:none; background:none; text-decoration:underline; font-size:12px; cursor:pointer;">ถ่ายใหม่</button>
            </div>
        </div>
    </div>

    <audio id="sndClick" src="https://www.soundjay.com/communication/shutter-click-06.mp3"></audio>
    <audio id="sndBeep" src="https://www.soundjay.com/buttons/beep-07.mp3"></audio>

    <script>
        const video = document.getElementById('video');
        const countdownEl = document.getElementById('countdown');
        const flashEl = document.getElementById('flash');
        let photos = [];

        async function openBooth() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            video.srcObject = stream;
            document.getElementById('startScreen').classList.add('hide');
            document.getElementById('boothScreen').style.display = 'flex';
        }

        async function startCapture() {
            photos = [];
            for (let i = 0; i < 4; i++) {
                await runTimer(3);
                capture(i);
                await new Promise(r => setTimeout(r, 600));
            }
            showResult();
        }

        function runTimer(sec) {
            return new Promise(resolve => {
                let t = sec;
                countdownEl.style.opacity = '1';
                const timer = setInterval(() => {
                    document.getElementById('sndBeep').play();
                    countdownEl.innerText = t;
                    if (t === 0) { clearInterval(timer); countdownEl.style.opacity = '0'; resolve(); }
                    t--;
                }, 800);
            });
        }

        function capture(idx) {
            document.getElementById('sndClick').play();
            flashEl.style.opacity = '1'; setTimeout(() => flashEl.style.opacity = '0', 100);
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);
            const data = canvas.toDataURL('image/jpeg', 0.8);
            photos.push(data);
            const slot = document.getElementById(`m${idx}`);
            slot.innerHTML = `<img src="${data}">`; slot.classList.add('active');
        }

        async function showResult() {
            const container = document.getElementById('resultImages');
            container.innerHTML = '';
            photos.forEach(p => {
                const d = document.createElement('div');
                d.className = 'film-img'; d.innerHTML = `<img src="${p}">`;
                container.appendChild(d);
            });
            document.getElementById('resultScreen').style.display = 'flex';
            
            // --- สร้างรูป Strip เพื่ออัปโหลด ---
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = 800; finalCanvas.height = 1900;
            const fCtx = finalCanvas.getContext('2d');
            fCtx.fillStyle = "white"; fCtx.fillRect(0,0,800,1900);
            fCtx.fillStyle = "#5A6B7F"; fCtx.font = "30px Arial"; fCtx.textAlign = "center"; fCtx.fillText("SENA PHOTOBOOTH", 400, 80);
            let y = 140;
            for(let p of photos) {
                const img = await new Promise(r => { const i = new Image(); i.onload = ()=>r(i); i.src=p; });
                fCtx.drawImage(img, 60, y, 680, 410); y += 430;
            }
            
            uploadAndGenerateQR(finalCanvas.toDataURL('image/jpeg', 0.9));
        }

        async function uploadAndGenerateQR(base64Data) {
            try {
                // ใช้ ImgBB API (Free Key สำหรับทดสอบ)
                const apiKey = '676d911b6678b8723c3b0f55e3780a47'; // <--- ถ้าใช้เยอะๆ แนะนำสมัครเองฟรีครับ
                const formData = new FormData();
                formData.append('image', base64Data.split(',')[1]);

                const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                const url = result.data.url;

                // สร้าง QR Code จากลิงก์ที่ได้จริง
                document.getElementById('qrcode').innerHTML = "";
                new QRCode(document.getElementById("qrcode"), { text: url, width: 120, height: 120 });
            } catch (e) {
                document.getElementById('qrcode').innerHTML = "<small>เน็ตมีปัญหาจ้า</small>";
            }
        }
    </script>
</body>
</html>
