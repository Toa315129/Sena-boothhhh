<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SENA PHOTOBOOTH | OS</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@500;700&family=VT323&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. RETRO SYSTEM STYLES
           ========================================= */
        :root {
            --bg-color: #121212;
            --screen-color: #0F380F; /* Classic Gameboy dark green tint */
            --phosphor-main: #FFFFFF;
            --phosphor-dim: #AAAAAA;
            --accent: #FF3333; 
            --scanline: rgba(0, 0, 0, 0.5);
            --font-ui: 'DM Sans', sans-serif;
            --font-digi: 'VT323', monospace;
        }

        body {
            margin: 0; padding: 0;
            background: #000;
            height: 100vh;
            overflow: hidden;
            color: var(--phosphor-main);
            font-family: var(--font-ui);
            display: flex; justify-content: center; align-items: center;
        }

        /* The CRT Screen Container */
        #crt-monitor {
            width: 100%; height: 100%;
            background: var(--bg-color);
            position: relative;
            overflow: hidden;
            /* subtle curve effect via box-shadow inset if desired, but keeping it flat per request for "system screen" */
        }

        /* SCANLINE OVERLAY (The Retro Soul) */
        .scanlines {
            position: absolute; inset: 0; pointer-events: none; z-index: 999;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            animation: flicker 0.15s infinite;
        }
        @keyframes flicker { 
            0% { opacity: 0.9; } 
            50% { opacity: 0.95; } 
            100% { opacity: 0.9; } 
        }

        /* =========================================
           2. SCREENS & LAYOUTS
           ========================================= */
        .screen-layer {
            position: absolute; inset: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
            z-index: 10;
        }
        .screen-layer.active { opacity: 1; pointer-events: auto; }

        /* --- SCREEN 1: INSERT COIN (ATTRACT MODE) --- */
        #screen-coin {
            background: radial-gradient(circle at center, #2a2a2a 0%, #000 100%);
            text-align: center;
        }
        
        .logo-main {
            font-family: var(--font-digi);
            font-size: 6rem; line-height: 0.8;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
            margin-bottom: 40px;
        }
        .logo-sub {
            font-family: var(--font-ui);
            font-size: 1.2rem; letter-spacing: 5px; opacity: 0.7;
            margin-bottom: 60px;
        }

        /* THE COIN SLOT BUTTON */
        .coin-btn {
            background: transparent;
            border: 4px solid var(--phosphor-main);
            color: var(--phosphor-main);
            padding: 20px 40px;
            font-family: var(--font-digi);
            font-size: 2.5rem;
            cursor: pointer;
            position: relative;
            text-shadow: 0 0 5px white;
            box-shadow: 0 0 15px rgba(255,255,255,0.2), inset 0 0 15px rgba(255,255,255,0.2);
            animation: pulse 1.5s infinite;
        }
        .coin-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.2); }
        .coin-label { font-size: 1rem; font-family: var(--font-ui); margin-top: 15px; opacity: 0.5; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- SCREEN 2: SYSTEM UI (CAMERA) --- */
        #screen-ui {
            justify-content: flex-start;
        }

        /* Top Bar */
        .sys-header {
            width: 100%; height: 60px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px;
            background: #000;
            border-bottom: 2px solid #333;
            font-family: var(--font-digi); font-size: 1.5rem;
        }

        /* Viewfinder */
        .viewport-container {
            flex: 1; width: 100%; position: relative;
            background: #000;
            display: flex; justify-content: center; overflow: hidden;
        }
        video#cam-feed {
            height: 100%; object-fit: cover; transform: scaleX(-1);
        }

        /* UI Overlays on Camera */
        .rec-indicator {
            position: absolute; top: 20px; right: 20px;
            color: var(--accent); font-family: var(--font-ui); font-weight: 700;
            display: flex; align-items: center; gap: 5px;
            text-shadow: 0 0 5px var(--accent);
        }
        .rec-dot { width: 12px; height: 12px; background: var(--accent); border-radius: 50%; }

        /* Countdown Big Number */
        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-family: var(--font-digi); font-size: 15rem;
            color: #FFF; text-shadow: 4px 4px 0 #000;
            display: none;
        }

        /* Bottom Controls */
        .sys-controls {
            width: 100%; height: 120px;
            background: #000;
            border-top: 2px solid #333;
            display: flex; align-items: center; justify-content: center; gap: 30px;
            padding: 10px;
        }

        .sys-btn {
            background: #222; border: 1px solid #444; color: #fff;
            font-family: var(--font-ui); font-size: 0.9rem;
            width: 80px; height: 80px; border-radius: 10px;
            cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;
        }
        .sys-btn.active { background: #fff; color: #000; box-shadow: 0 0 10px #fff; }

        .shutter-ring {
            width: 90px; height: 90px; border: 2px solid #555; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .shutter-inner {
            width: 70px; height: 70px; background: var(--phosphor-main); border-radius: 50%;
            transition: 0.1s;
        }
        .shutter-ring:active .shutter-inner { transform: scale(0.9); background: var(--accent); }

        /* --- SCREEN 3: RESULT --- */
        #screen-result {
            background: #111;
        }
        .result-stage {
            max-height: 70vh; margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border: 1px solid #333;
        }
        .result-stage img { height: 100%; display: block; }
        
        .action-bar { display: flex; gap: 15px; }
        .action-btn {
            padding: 15px 30px; font-family: var(--font-digi); font-size: 1.5rem;
            border: 2px solid #fff; background: transparent; color: #fff;
            cursor: pointer; text-transform: uppercase;
        }
        .action-btn:hover { background: #fff; color: #000; }

        /* FLASH */
        #flash { position: fixed; inset:0; background:#fff; z-index:9999; opacity:0; pointer-events:none; }
        .do-flash { animation: flashAnim 0.2s linear; }
        @keyframes flashAnim { 0%,100% { opacity:0; } 50% { opacity:1; } }

    </style>
</head>
<body>

    <div id="crt-monitor">
        <div class="scanlines"></div>

        <div id="screen-coin" class="screen-layer active">
            <div class="logo-main">SENA<br>SYSTEM</div>
            <div class="logo-sub">PHOTO IMAGING OS v.1.0</div>
            
            <button class="coin-btn" onclick="System.insertCoin()">
                INSERT COIN
            </button>
            <div class="coin-label">CREDIT 0/1</div>
        </div>

        <div id="screen-ui" class="screen-layer">
            <div class="sys-header">
                <span>CAM-01 [LIVE]</span>
                <span id="date-display">00:00</span>
            </div>

            <div class="viewport-container">
                <video id="cam-feed" autoplay playsinline muted></video>
                <div class="rec-indicator"><div class="rec-dot"></div> REC</div>
                <div id="countdown">3</div>
            </div>

            <div class="sys-controls">
                <button class="sys-btn active" onclick="System.setFilter('color', this)">COLOR</button>
                <button class="sys-btn" onclick="System.setFilter('bw', this)">B/W</button>
                
                <div class="shutter-ring" onclick="System.snap()">
                    <div class="shutter-inner"></div>
                </div>

                <button class="sys-btn" style="opacity:0.5; pointer-events:none;">FILM</button> </div>
        </div>

        <div id="screen-result" class="screen-layer">
            <div style="font-family: var(--font-digi); font-size: 2rem; margin-bottom: 20px;">PRINT COMPLETE</div>
            <div class="result-stage">
                <img id="final-img" alt="Photo Strip">
            </div>
            <div class="action-bar">
                <button class="action-btn" onclick="System.download()">DOWNLOAD</button>
                <button class="action-btn" onclick="location.reload()">RESTART</button>
            </div>
        </div>

    </div>

    <div id="flash"></div>
    <canvas id="hidden-canvas" style="display:none;"></canvas>

    <script>
        const System = (function() {
            
            // CONFIG
            const C = {
                w: 1280, h: 720,
                stripW: 600,
                shots: 3
            };

            // STATE
            let state = {
                filter: 'color',
                photos: [],
                stream: null
            };

            // AUDIO (Simple Beeps)
            const Audio = {
                ctx: null,
                play: function(type) {
                    if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const o = this.ctx.createOscillator();
                    const g = this.ctx.createGain();
                    o.connect(g); g.connect(this.ctx.destination);
                    
                    if(type === 'coin') {
                        o.frequency.value = 1200; o.type = 'sine';
                        g.gain.value = 0.1; o.start(); o.stop(this.ctx.currentTime+0.2);
                    } else if(type === 'shutter') {
                        o.frequency.value = 100; o.type = 'sawtooth';
                        g.gain.value = 0.1; o.start(); o.stop(this.ctx.currentTime+0.1);
                    }
                }
            };

            // DOM
            const D = {
                screens: {
                    coin: document.getElementById('screen-coin'),
                    ui: document.getElementById('screen-ui'),
                    result: document.getElementById('screen-result')
                },
                video: document.getElementById('cam-feed'),
                canvas: document.getElementById('hidden-canvas'),
                count: document.getElementById('countdown'),
                flash: document.getElementById('flash'),
                finalImg: document.getElementById('final-img'),
                date: document.getElementById('date-display')
            };

            // CLOCK
            setInterval(() => {
                const d = new Date();
                D.date.innerText = d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0');
            }, 1000);

            // METHODS
            async function insertCoin() {
                Audio.play('coin');
                try {
                    state.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'user', width: C.w, height: C.h } 
                    });
                    D.video.srcObject = state.stream;
                    
                    // Boot Sequence
                    D.screens.coin.classList.remove('active');
                    setTimeout(() => D.screens.ui.classList.add('active'), 500);
                    
                } catch(e) {
                    alert('SYSTEM ERROR: NO CAMERA DETECTED');
                }
            }

            function setFilter(f, el) {
                state.filter = f;
                document.querySelectorAll('.sys-btn').forEach(b => b.classList.remove('active'));
                el.classList.add('active');
                D.video.style.filter = f === 'bw' ? 'grayscale(100%) contrast(1.2)' : 'none';
            }

            async function snap() {
                state.photos = [];
                // Disable controls
                document.querySelector('.sys-controls').style.pointerEvents = 'none';

                for(let i=0; i<C.shots; i++) {
                    await countdown(3);
                    await capture();
                }

                processImage();
            }

            function countdown(n) {
                return new Promise(r => {
                    let c = n;
                    D.count.style.display = 'block';
                    D.count.innerText = c;
                    const t = setInterval(() => {
                        c--;
                        if(c>0) D.count.innerText = c;
                        else {
                            clearInterval(t);
                            D.count.style.display = 'none';
                            r();
                        }
                    }, 1000);
                });
            }

            function capture() {
                return new Promise(r => {
                    Audio.play('shutter');
                    D.flash.classList.add('do-flash');
                    setTimeout(()=>D.flash.classList.remove('do-flash'), 200);

                    const cvs = document.createElement('canvas');
                    cvs.width = D.video.videoWidth; cvs.height = D.video.videoHeight;
                    const ctx = cvs.getContext('2d');
                    
                    // Mirror & Draw
                    ctx.translate(cvs.width, 0); ctx.scale(-1, 1);
                    ctx.drawImage(D.video, 0, 0);
                    
                    // Apply B&W if needed
                    if(state.filter === 'bw') {
                        const imgData = ctx.getImageData(0,0,cvs.width,cvs.height);
                        const d = imgData.data;
                        for(let i=0; i<d.length; i+=4) {
                            const avg = (d[i]+d[i+1]+d[i+2])/3;
                            d[i]=d[i+1]=d[i+2]=avg;
                        }
                        ctx.putImageData(imgData, 0, 0);
                    }

                    state.photos.push(cvs);
                    setTimeout(r, 800);
                });
            }

            function processImage() {
                // STOP CAM
                if(state.stream) state.stream.getTracks().forEach(t=>t.stop());

                const stripW = C.stripW;
                const photoW = 540; const photoH = (photoW*3)/4;
                const gap = 30; const head = 150; const foot = 100;
                const totalH = head + (photoH*3) + (gap*2) + foot;

                D.canvas.width = stripW; D.canvas.height = totalH;
                const ctx = D.canvas.getContext('2d');

                // 1. BG
                ctx.fillStyle = '#EEE'; // Off white paper
                ctx.fillRect(0,0,stripW, totalH);

                // 2. HEADER
                ctx.fillStyle = '#000';
                ctx.textAlign = 'center';
                // Use DM Sans for the Logo (Same as first page style)
                ctx.font = 'bold 60px "DM Sans"';
                ctx.fillText('SENA', stripW/2, 80);
                
                ctx.font = '30px "VT323"'; // Retro sub-text
                ctx.fillText('SENAPHOTOBOOTH', stripW/2, 120);

                // 3. PHOTOS
                let y = head;
                state.photos.forEach(p => {
                    // Center Crop
                    const sRatio = p.width/p.height; const dRatio = 4/3;
                    let sx, sy, sw, sh;
                    if(sRatio > dRatio) { sh=p.height; sw=sh*dRatio; sx=(p.width-sw)/2; sy=0; }
                    else { sw=p.width; sh=sw/dRatio; sx=0; sy=(p.height-sh)/2; }
                    
                    ctx.drawImage(p, sx, sy, sw, sh, (stripW-photoW)/2, y, photoW, photoH);
                    
                    // DATE STAMP (Vintage Style)
                    ctx.fillStyle = '#FF9900'; 
                    ctx.font = '24px "VT323"'; ctx.textAlign = 'right';
                    const dateStr = new Date().toLocaleDateString('en-GB'); // DD/MM/YYYY
                    ctx.fillText(dateStr, (stripW-photoW)/2 + photoW - 10, y + photoH - 10);

                    y += photoH + gap;
                });

                // 4. FOOTER
                ctx.fillStyle = '#888'; ctx.textAlign = 'center';
                ctx.font = '20px "DM Sans"';
                ctx.fillText('www.sena-booth.com', stripW/2, totalH - 40);

                // SHOW RESULT
                D.finalImg.src = D.canvas.toDataURL('image/jpeg', 0.95);
                D.screens.ui.classList.remove('active');
                D.screens.result.classList.add('active');
            }

            function download() {
                // FIXED DOWNLOAD LOGIC
                const link = document.createElement('a');
                link.download = `SENA_SYSTEM_${Date.now()}.jpg`;
                link.href = D.canvas.toDataURL('image/jpeg', 1.0);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            return { insertCoin, setFilter, snap, download };

        })();
    </script>
</body>
</html>
